{% extends 'base.html' %}

{% block content %}
<div class="mt-4">
    {% include 'reports/user/user_navtab.html' with active_tab='authentication_security_report' %}

    <div class="container mt-4">
        <h1>Authentication & Security Report</h1>
        <p>Reporting period: {{ start_of_week }} to {{ end_of_week }}</p>
        
        <!-- 2FA Enabled/Disabled Chart -->
        <h2>2FA Enabled Status</h2>
        <div class="chart-container">
            <canvas id="twoFaStatusChart"></canvas>
        </div>

        <form method="GET" action="{% url 'reports:authentication_security_report' %}" class="mb-4">
            <div class="input-group">
                <input type="text" name="search" class="form-control" placeholder="Search by username" value="{{ search_query }}">
                <button type="submit" class="btn btn-search">
                    <i class="fa fa-search"></i> <!-- Font Awesome search icon -->
                </button>
            </div>
        </form>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Total Logins</th>
                    <th>Successful Logins</th>
                    <th>Email Notifications Sent (Failed 2FA Attempts)</th>
                    <th>Last Login</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in login_data %}
                <tr>
                    <td>{{ entry.user__username }}</td>
                    <td>{{ entry.total_logins }}</td>
                    <td>{{ entry.successful_logins }}</td>
                    <td>{{ entry.email_notifications }}</td>
                    <td>{{ entry.last_login }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No login data available for this week.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- Pagination controls -->
        <div class="pagination">
            <span class="step-links">
                {% if login_data.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; first</a>
                    <a href="?page={{ login_data.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">previous</a>
                {% endif %}

                <span class="current">
                    Page {{ login_data.number }} of {{ login_data.paginator.num_pages }}.
                </span>

                {% if login_data.has_next %}
                    <a href="?page={{ login_data.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">next</a>
                    <a href="?page={{ login_data.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">last &raquo;</a>
                {% endif %}
            </span>
        </div>

        <!-- 2FA Enabled/Disabled User List (Initially hidden) -->
        <div id="enabledUsersList" style="display: none;">
            <h3>Users with 2FA Enabled</h3>
            <ul>
                {% for user in two_fa_enabled_users %}
                    <li>{{ user.username }}</li>
                {% empty %}
                    <li>No users with 2FA enabled.</li>
                {% endfor %}
            </ul>
        </div>

        <div id="disabledUsersList" style="display: none;">
            <h3>Users with 2FA Disabled</h3>
            <ul>
                {% for user in two_fa_disabled_users %}
                    <li>{{ user.username }}</li>
                {% empty %}
                    <li>No users with 2FA disabled.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- CSS to adjust chart size -->
<style>
    .input-group {
        max-width: 30vh;  
        margin: 0;        
        display: flex;    
        align-items: center; 
    }
    .form-control {
        height: 3.5vh;     
        font-size: 1.5vh; 
        border-radius: 0;
    }
    .btn-search {
        background-color: white;
        border: 1px solid #007bff; 
        color: #007bff; 
        padding: 0.8vh 2vh;
        font-size: 0vh;   
        border-radius: 0; 
    }
    .btn-search:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3; 
    }
    .btn-search i {
        font-size: 1.6vh; 
        color: #007bff; 
    }

    .chart-container {
        max-width: 40vh; 
        max-height: 40vh;
        margin: auto;
    }

    #twoFaStatusChart {
        width: 100% !important;
        height: auto !important;
    }
</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('twoFaStatusChart').getContext('2d');
    const twoFaEnabledCount = {{ two_fa_enabled_count }};
    const twoFaDisabledCount = {{ two_fa_disabled_count }};

    const twoFaStatusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['2FA Enabled', '2FA Disabled'],
            datasets: [{
                data: [twoFaEnabledCount, twoFaDisabledCount],
                backgroundColor: ['#A5D6A7', '#BDBDBD'], // Light green and light gray
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            return `${label}: ${value} users`;
                        }
                    }
                }
            }
        }
    });

    // Event listener for click on chart sections
    ctx.onclick = function(event) {
        const activePoint = twoFaStatusChart.getElementsAtEventForMode(event, 'nearest', {intersect: true});
        if (activePoint.length) {
            const clickedIndex = activePoint[0].index;
            const selectedStatus = clickedIndex === 0 ? 'enabled' : 'disabled';
            displayUsers(selectedStatus);
        }
    };

    function displayUsers(status) {
        const enabledList = document.getElementById('enabledUsersList');
        const disabledList = document.getElementById('disabledUsersList');

        if (status === 'enabled') {
            enabledList.style.display = 'block';
            disabledList.style.display = 'none';
        } else if (status === 'disabled') {
            disabledList.style.display = 'block';
            enabledList.style.display = 'none';
        }
    }
</script>
{% endblock %}
