{% extends 'base.html' %}
{% block content %}
{% include 'reports/user/user_navtab.html' with active_tab='role' %}
<div class="mt-4">
    <div class="container-fluid mt-4">  
        <h1 class="text-center mb-4">Number of Users by Role</h1>

        <!-- Canvas for Charts in the Same Row -->
        <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; margin-top: 20px;">
            
            <!-- Canvas for Pie Chart (Role Chart) -->
            <div class="mb-4" style="max-width: 33%; max-height: 100vh;">
                <canvas id="rolePieChart" style="width: 100%; height: 100%;"></canvas>
            </div>

            <!-- Canvas for Pie Chart (Modules Chart) -->
            <div class="mb-4" style="max-width: 33%; max-height: 100vh;">
                <canvas id="modulesChart" style="width: 100%; height: 100%;"></canvas>
            </div>

            <!-- Canvas for Pie Chart (Permissions Chart) -->
            <div class="mb-4" style="max-width: 33%; max-height: 100vh;">
                <canvas id="permissionsChart" style="width: 100%; height: 100%;"></canvas>
            </div>

        </div>


        <!-- Table for Role Details (Roles, Modules, Permissions) -->
        <h2 class="text-center mt-5">Roles, Modules, and Permissions</h2>
        <div class="table-responsive" style="max-width: 100vw;">
            <table class="table table-striped table-bordered table-sm mt-3">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Role Name</th>
                        <th scope="col">Modules</th>
                        <th scope="col">Permissions</th>
                        <th scope="col">Number of Users</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role, details in role_permissions.items %}
                        <tr>
                            <td>{{ role }}</td>
                            <td>
                                {% if details.modules %}
                                    <span>
                                        {% for module in details.modules|slice:":3" %}
                                            {{ module }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                        {% if details.modules|length > 3 %}
                                            <ul id="modules-{{ forloop.counter }}" class="full-list" style="display: none;">
                                                {% for module in details.modules|slice:"3:" %}
                                                    <li>{{ module }}</li>
                                                {% endfor %}
                                            </ul>
                                            <a href="#" class="view-more" data-target="modules-{{ forloop.counter }}">...View More</a>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span>No modules assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if details.permissions %}
                                    <span>
                                        {% for permission in details.permissions|slice:":3" %}
                                            {{ permission.name }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                        {% if details.permissions|length > 3 %}
                                            <ul id="permissions-{{ forloop.counter }}" class="full-list" style="display: none;">
                                                {% for permission in details.permissions|slice:"3:" %}
                                                    <li>{{ permission.name }}</li>
                                                {% endfor %}
                                            </ul>
                                            <a href="#" class="view-more" data-target="permissions-{{ forloop.counter }}">...View More</a>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span>No permissions assigned</span>
                                {% endif %}
                            </td>
                            <td>{{ details.user_count }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Data for Pie Chart
    const roleLabels = [{% for role_count in role_counts %}"{{ role_count.role__role_name }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const roleData = [{% for role_count in role_counts %}{{ role_count.user_count }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    // Create Pie Chart for Roles
    const ctxRole = document.getElementById('rolePieChart').getContext('2d');
    const rolePieChart = new Chart(ctxRole, {
        type: 'pie',
        data: {
            labels: roleLabels,
            datasets: [{
                label: 'Number of Users',
                data: roleData,
                backgroundColor: [
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, position: 'top' },
                title: { display: true, text: 'User Count by Role' }
            }
        }
    });

    // Data for Modules Chart
    const moduleLabels = [{% for role, details in role_permissions.items %}"{{ role }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const moduleData = [{% for role, details in role_permissions.items %}{{ details.modules|length }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    // Create Bar Chart for Modules
    const ctxModules = document.getElementById('modulesChart').getContext('2d');
    const modulesChart = new Chart(ctxModules, {
        type: 'bar',
        data: {
            labels: moduleLabels,
            datasets: [{
                label: 'Number of Modules',
                data: moduleData,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Modules Assigned to Roles' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Data for Permissions Chart
    const permissionLabels = [{% for role, details in role_permissions.items %}"{{ role }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const permissionData = [{% for role, details in role_permissions.items %}{{ details.permissions|length }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    // Create Bar Chart for Permissions
    const ctxPermissions = document.getElementById('permissionsChart').getContext('2d');
    const permissionsChart = new Chart(ctxPermissions, {
        type: 'bar',
        data: {
            labels: permissionLabels,
            datasets: [{
                label: 'Number of Permissions',
                data: permissionData,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Permissions Assigned to Roles' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
<script>
    // Toggle the full list when clicking 'View More'
    document.querySelectorAll('.view-more').forEach(function(link) {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            var targetId = this.getAttribute('data-target');
            var fullList = document.getElementById(targetId);
            if (fullList.style.display === 'none') {
                fullList.style.display = 'block';
                this.textContent = '...View Less';
                this.style.textAlign = 'center';  // Align the "View Less" link at the center below the list
            } else {
                fullList.style.display = 'none';
                this.textContent = '...View More';
            }
        });
    });
</script>
{% endblock %}
