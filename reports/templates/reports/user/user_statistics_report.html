{% extends 'base.html' %}

{% block content %}
{% include 'reports/user/user_navtab.html' with active_tab='user_statistics' %}
<div class="mt-4">
    

    <div class="container mt-4">
        <h1 class="text-center mb-4">User Statistics</h1>

        <!-- Thanh tìm kiếm cho tuần -->
        <form method="GET" class="d-flex mb-3">
            <button type="submit" name="week_offset" value="{{ week_offset|add:"-1" }}" class="btn btn-secondary me-2">
                Previous Week
            </button>
            <button type="submit" name="week_offset" value="{{ week_offset|add:"1" }}" class="btn btn-secondary me-2">
                Next Week
            </button>
            <span class="align-self-center">
                Week of {{ login_dates.0 }} to {{ login_dates.6 }}
            </span>
        </form>

        <!-- Dùng Flexbox để tạo bố cục với biểu đồ ở trên và bảng ở dưới -->
        <div class="d-flex flex-column align-items-center">
            <!-- Biểu đồ số lần đăng nhập -->
            <div style="width: 80%; margin-bottom: 30px;">
                <h3 class="text-center">Week from {{ login_dates.0 }} to {{ login_dates.6 }}</h3>
                <canvas id="loginCountsChart" width="800" height="300"></canvas>
            </div>

            <!-- Bảng người dùng đã đăng nhập trong ngày đã chọn -->
            <div id="userList" style="width: 80%;">
                <h4>
                    {% if selected_login_date %}
                        Users who logged in on {{ selected_login_date }}:
                    {% else %}
                        Users who logged in during the selected week:
                    {% endif %}
                </h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Date Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.date_joined }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center">No users logged in on this date.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Biểu đồ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const loginDates = {{ login_dates|safe }};
        const userCounts = {{ user_counts|safe }};
        const ctx = document.getElementById('loginCountsChart').getContext('2d');
        const loginCountsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: loginDates,
                datasets: [{
                    label: 'User Login Counts',
                    data: userCounts,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1,
                    barThickness: 70
                }]
            },
            options: {
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const selectedDate = loginDates[index];
                        window.location.href = `/reports/user/user_statistics_report/?login_date=${selectedDate}`;
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Users'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Login Dates'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    }
                },
                barPercentage: 0.6,
                categoryPercentage: 0.8
            }
        });
    });
</script>
{% endblock %}