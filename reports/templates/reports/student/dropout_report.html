{% extends 'base.html' %}

{% block content %}
<div class="mt-4">
    <!-- Include navigation bar -->
    {% include 'reports/student/student_navtab.html' with active_tab='check_dropout_users' %}

    <h1 class="mb-4">Statistics of Students at Risk of Dropping Out</h1>

    <h2>Course Completion Statistics Chart</h2>
    <!-- Chart -->
    <div class="row mb-4">
        <div class="col">
            <canvas id="courseChart" width="300" height="450"></canvas> <!-- Smaller chart -->
        </div>
    </div>

    <h3>List of Students at Risk of Dropping Out</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>#</th>
                <th>Student</th>
                <th>Course</th>
                <th>Completion Percentage</th>
                <th>Time Incomplete (seconds)</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in dropout_students %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ entry.student.username }}</td>
                <td>{{ entry.course.course_name }}</td>
                <td>{{ entry.completion_percent }}%</td>
                <td>{{ entry.time_elapsed }} seconds</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"></script>

<script>
    // Data for the chart (using completion_percent instead of time_elapsed)
    var dropoutData = {
        labels: [
            {% for entry in dropout_students %}
                "{{ entry.student.username }} - {{ entry.course.course_name }}"{% if not forloop.last %}, {% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Completion Percentage',
            data: [
                {% for entry in dropout_students %}
                    {{ entry.completion_percent }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            ],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',  // Background color of the bars
            borderColor: 'rgba(54, 162, 235, 1)',  // Border color of the bars
            borderWidth: 1
        }]
    };

    // Draw the chart with customization for smaller size
    var ctx = document.getElementById('courseChart').getContext('2d');
    var courseChart = new Chart(ctx, {
        type: 'bar',
        data: dropoutData,
        options: {
            responsive: true, // Ensure the chart resizes when the screen changes
            maintainAspectRatio: false, // Allow aspect ratio change when resized
            scales: {
                y: {
                    beginAtZero: true,  // Ensure Y-axis starts at 0
                    max: 100,  // Limit Y-axis to 100
                    ticks: {
                        font: {
                            size: 10 // Adjust font size for Y-axis
                        },
                        callback: function(value) {
                            return value + "%";  // Display % next to the value on the Y-axis
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 8 // Adjust font size for X-axis
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
