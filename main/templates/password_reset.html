{% extends "base.html" %}
{% load static %}
{% load form_filters %}
{% load custom_filters %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="text-center mb-4">
                        {% if current_step == 'request' %}
                            Recovery Email
                        {% elif current_step == 'code' %}
                            Enter Code
                        {% elif current_step == 'reset' %}
                            Change Password
                        {% endif %}
                    </h2>

                    {% if messages %}
                    <div class="alert alert-warning" role="alert">
                        <ul>
                            {% for message in messages %}
                            <li>{{ message }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if current_step == 'code' %}
                        <div class="alert alert-info {% if not remaining_time %}d-none{% endif %}">
                            Thời gian còn lại để xác thực mã: 
                            <span id="countdown">
                                {% if remaining_time %}
                                    {{ minutes }} phút {{ seconds }} giây
                                {% else %}
                                    Mã đã hết hạn.
                                {% endif %}
                            </span>
                        </div>
                    {% endif %}

                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        <div class="form-group">
                            {% if current_step == 'request' %}
                                <input type="email" name="email" class="form-control" placeholder="Enter your email" value="{{ form.email.value|default_if_none:'' }}" required>
                            {% elif current_step == 'code' %}
                                <input type="text" name="code" class="form-control" placeholder="Enter your code" value="{{ form.code.value|default_if_none:'' }}" required>
                            {% elif current_step == 'reset' %}
                                <input type="password" name="new_password" class="form-control" placeholder="Enter new password" required>
                                <input type="password" name="confirm_password" class="form-control mt-2" placeholder="Confirm new password" required>
                            {% endif %}
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">
                            {% if current_step == 'request' %}
                                Send Code
                            {% elif current_step == 'code' %}
                                Confirm Code
                            {% elif current_step == 'reset' %}
                                Change Password
                            {% endif %}
                        </button>

                        {% if current_step == 'code' %}
                        <!-- Nút Gửi lại mã -->
                        <div class="text-center mt-3">
                            <button id="resend-button" type="button" class="btn btn-secondary btn-block" onclick="resendCode()" {% if remaining_time %}disabled{% endif %}>Gửi lại mã</button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let remainingTime = {{ remaining_time.total_seconds|default:0 }}; 
        const countdownElement = document.getElementById('countdown'); 
        const resendButton = document.getElementById('resend-button'); 
    
        resendButton.disabled = remainingTime > 0;
    
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60); 
            const remainingSeconds = Math.floor(seconds % 60); 
            return `${minutes} minutes ${remainingSeconds < 10 ? '0' : ''}${remainingSeconds} seconds`; 
        }
    
        function updateCountdown() {
            if (remainingTime > 0) {
                countdownElement.textContent = formatTime(remainingTime); 
                remainingTime--; 
    
                if (remainingTime <= 0) {
                    clearInterval(interval); 
                    countdownElement.textContent = "Mã đã hết hạn."; 
                    resendButton.disabled = false; 
                }
            }
        }
    
        const interval = setInterval(updateCountdown, 1000);
        updateCountdown();
    
        function resendCode() {
            if (resendButton.disabled) return; 
            window.location.href = "{% url 'main:resend_code_auto' %}";
        }
        window.resendCode = resendCode; 
    });      
</script>

<style>
    .card {
        transition: transform 0.3s;
    }
    .card:hover {
        transform: scale(1.02);
    }
</style>
{% endblock %}