{% extends 'base.html' %}
{% load custome_filters %}
{% block content %}
{% include 'reports/user/user_navtab.html' with active_tab='student_id' %}
<div class="mt-4">
    <div class="container mt-4">
        <h1 class="text-center mb-4">Number of students per semester</h1>

        
        <!-- Canvas for Chart -->
        <div class="d-flex justify-content-center">
            <canvas id="studentPieChart" style="max-width: 600px; max-height: 600px;"></canvas>
        </div>
        <!-- Form tìm kiếm -->
        <form method="get" class="mb-3">
            <div class="row g-2 align-items-center">
                <div class="col-10">
                    <input type="text" name="search" value="{{ search_query }}" class="form-control" placeholder="Search by Student Group">
                </div>
                <div class="col-2">
                    <button type="submit" class="btn btn-primary w-100">Search</button>
                </div>
            </div>
        </form>
        

        <!-- Bảng tổng kết -->
        <table class="table mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Student Group</th>
                    <th>Number of Students</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for summary in cohort_summary %}
                    <tr>
                        <!-- Sửa lại số thứ tự: tính toán dựa trên trang hiện tại -->
                        <td>{{ forloop.counter0|add:page_obj.start_index }}</td>

                        <td>{{ summary.label }}</td>
                        <td>{{ summary.count }}</td>
                        <td>
                            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#studentDetailsModal" data-group="{{ summary.label }}">
                                View Students
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- Modal to display student details -->
        <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDetailsLabel">Student Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="studentDetailsBody">
                        <!-- Student details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Phân trang -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&search={{ query }}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ query }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% endif %}
        
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}&search={{ query }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
        
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ query }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&search={{ query }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    

        <!-- Modal to display student details -->
        <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDetailsLabel">Student Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="studentDetailsBody">
                        <!-- Student details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Hàm xử lý khi modal mở ra
    $('#studentDetailsModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Lấy nút nhấn
        var group = button.data('group'); // Lấy nhóm sinh viên từ data-group

        // Gửi yêu cầu Ajax để lấy thông tin chi tiết sinh viên trong nhóm
        $.ajax({
            url: "{% url 'reports:student_group_details' %}",  // Cập nhật đường dẫn URL trong Django
            data: {
                'group': group
            },
            success: function (data) {
                // Cập nhật nội dung modal với thông tin chi tiết sinh viên
                var studentDetails = data.students; // Dữ liệu trả về từ Ajax (sinh viên trong nhóm)
                var htmlContent = '<table class="table"><thead><tr><th>Name</th><th>Student Code</th></tr></thead><tbody>';
                
                studentDetails.forEach(function(student) {
                    htmlContent += '<tr><td>' + student.name + '</td><td>' + student.code + '</td></tr>';
                });
                
                htmlContent += '</tbody></table>';
                $('#studentDetailsBody').html(htmlContent); // Hiển thị nội dung vào modal
            }
        });
    });
</script>

<script>
    const ctx = document.getElementById('studentPieChart').getContext('2d');
    const labels = {{ labels|safe }};  // Nhãn từ views.py
    const data = {{ data|safe }};  // Dữ liệu từ views.py

    const studentBarChart = new Chart(ctx, {
        type: 'bar',  // Chuyển từ pie sang bar
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Students per Student Code',
                data: data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Number of Students per Student Code'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Student Code'
                    },
                    ticks: {
                        autoSkip: false,  // Không bỏ qua các nhãn
                        maxRotation: 90,  // Xoay nhãn nếu cần thiết
                        minRotation: 45
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Number of Students'
                    }
                }
            }
        }
    });
</script>

{% endblock %}
